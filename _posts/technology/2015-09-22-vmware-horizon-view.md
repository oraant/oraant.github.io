---
layout: post
title: 桌面虚拟化入门-Vmware Horizon View 6 For Linux VDI
description: 真正的从零开始，让你了解什么是桌面云，怎么搭建，以及怎么使用。
category: technology
tags: vmware,桌面虚拟化,云桌面
---

## 桌面虚拟化到底是什么

### 提前声明
 
桌面虚拟化有很多概念，此处谈论的，是指的一般企业使用的“服务器 + 虚拟机 + 云终端”的方式来实现的，详见下文。
 
### 桌面虚拟化的原理
 
桌面虚拟化看上去高大上，听上去云里雾里，实际上原理非常的简单。拿VMware的Horizon View来说，整个架构是这个样子的：

1. 利用VMware相关产品，在服务器上面，部署多套虚拟机，每个虚拟机都是一个完整的操作系统。
2. 利用Windows的域功能，建立多个用户，用以区分哪个用户登录哪个虚拟机
3. 利用view Client软件，在云终端设备上，连接到服务器中的某一台虚拟机上操作。你一定使用过QQ的远程协助功能，此处可以想象一下。

以上。

是不是很简单？一言以蔽之，就是“搞几个服务器，弄出一堆虚拟机来，然后在瘦客户机或零终端上，用相应的Client，通过PCoIP协议，连接到相应的虚拟机上”。
 
搞运维的人基本上都用过虚拟机，比如是VMware或者VirtualBox，同时也大多使用过远程桌面软件，比如VNC、Xmanager等等，如果你都用过，相信看了上面的简述，你一定很容易的就理解了桌面虚拟化。没错，桌面虚拟化的原理，就是简单的建些虚拟机并用远程桌面连过去！
 
当然，实际情况没那么简单，整套的桌面虚拟化解决方案，在高可用、稳定性、流畅度等等方面是“建些虚拟机并用远程桌面连过去”这种简单方式无法比拟的（虽然我采购时发现，国内居然还真有提供这种解决方案的厂家）。
 
### 桌面虚拟化的作用

使用云桌面会给企业带来怎么样的效果？

- 首先，省维护，添加主机、修改配置啥的，增加资源，挂盘安装等等操作，鼠标点点，就能完成。
- 再就是省电，由主机变成了小盒子（云终端），功率一般在25w左右。
- 还有就是使用方便，搭建好了，只要有网能连上桌面，就能随时连上自己的虚拟机，不用抱着个笔记本电脑到处跑。
- 最后就是省钱，ARM零终端一般400~800一个，x86瘦客户机800~1200一个，芯片零终端在2000~3000一个。零终端和瘦客户机比电脑要便宜很多。当然，要是用正版软件授权，加上服务器的购买，那就不好说了。但是怎么看，前三个优点都是蛮诱人的。
 
### 虚拟桌面的实现途径
 
实现虚拟桌面有哪些途径呢，最主流的解决方案，是vmware、微软、xen、cirix四种，理论上，openstack应该也是可以做到的。当然，笔者没有精力将这些方案都试一遍，本套教程中，只介绍VMware的桌面虚拟化产品——Horizon View。
 
### 类似于云桌面的应用
 
实际上，类似的解决方案还真不少。

- 有的是直接在virtual box上装个软件和自己生产的云终端硬件相连，有的是从虚拟化到云桌面一整套方案等等。
- 再就是经典的电脑拖机，一个电脑能拖给好多个人使用，别人也是用个小盒就行。
- 再就是网吧常用的无盘工作站，虽然看上去有点相似，但原理还是不一样的。像vmware的虚拟化，每个人都对应一个专门的虚拟机。
- 再就是……嗯，一些web版的合作办公了，比如dzz office之类的。

## 安装前的准备工作

### 环境说明

>注，本套环境所用机器全部是64位的。

- 管理服务器载体：安装win7操作系统，通过VMware Workstation安装4台虚拟机，用作vCenter，Connection Server，Domain Control三台管理服务器，以及一台模板服务器。
- 虚拟桌面载体：安装ESXi操作系统，用来存放虚拟机。
- 终端机若干：安装Win7操作系统，用来安装View Client软件，连接服务器上的虚拟桌面。
- 网络说明：由于本环境仅限内网访问，故为保证整套环境网络拓扑简单，所有设备、系统均为单网卡，且都在同一网段内。

### 拓扑图

拓扑图如下，其中**蓝色**图形为实际机器，**绿色**图形为虚拟机，**黄色**图形为软件。

![](/images/2015-09-22-vmware-horizon-view/topological.png)

### 名词解释

1，一共几台服务器？都需要什么操作系统？上面需要什么应用？安装了哪些软件？

- DC服务器：安装了`Windows Server 2008 R2 SP1`系统，并安装了`Domain Control`的**虚拟机**服务器。
- VC服务器：安装了`Windows Server 2008 R2 SP1`系统，并安装了`VMware vCenter`的**虚拟机**服务器。
- CS服务器：安装了`Windows Server 2008 R2 SP1`系统，并安装了`Connection Server`的**虚拟机**服务器。
- 模板服务器：安装了`ESXi5.5`系统，并在上面部署了`Rhel6.6`系统模板虚拟机的**虚拟机**服务器。
- 管理服务器载体：普通Win7系统，通过VMware Workstation搭建了上面四台虚拟机服务器的**物理主机**。
- 虚拟桌面载体：安装了`ESXi5.5`系统，并在上面部署了很多台Rhel6.6系统虚拟机的**物理主机**。
- 云终端：安装了32位的普通Win7系统，安装`View Client`来连接虚拟桌面的**物理设备**。

2，上面的解释中的名词都是什么意思呢？

- `Domain Control`：微软的产品，即著名的域控制器。域的一个作用就是用户管理，比方说你有10台电脑，你想在10台电脑上分别建立5个相同的账户，那你是不是要每个电脑都要重复的建立5个用户？但如果有一台服务器建立了一个域，10台电脑都加入了这个域，那么只要在域服务器上建立5个用户，并赋予相关的权限，就能拿着这5个账号登陆任何一个有权限的电脑了。嗯……有点像统一密码管理器的作用。当然域的作用远不止于此，但这样方便从未接触过的人理解——加入域的电脑可以共享用户名及密码。
- `VMware vCenter`：VMware公司的软件，用来同时管理多台ESXi主机，可以通过vSphere Client连接到vCenter服务器上，同时对多台ESXi主机进行图形化管理。vCenter也提供网页方式来进行访问。
- `Connection Server`：VMware公司的软件，属于Horizon View中的一块内容，用于处理云终端到虚拟机的连接。可以理解为虚拟机到云终端之间的一个桥梁。
- `Windows Server 2008 R2 SP1`：大家都知道Windows操作系统，其实`Windows Server`就是微软开发的专门针对服务器的Windows系统。2008是大版本，就类似于Win7、Win8一样。R2是Realease 2的意思，代表着第二个发行版，就像QQ5.1，QQ5.2一样。SP1是打了第一个补丁包，就像QQ5.2.1一样……吧。
- `Rhel6.6`：即红帽6.6企业版，要是红帽都不知道……那还是别看了。
- `ESXi5.5`：VMware公司的产品，完全可以理解为操作系统，版本为5.5。安装这种系统后，界面类似一个文字终端，可以利用vSphere Client连接过去进行图形化管理，如建立、删除虚拟机，更改配置，增删硬件等。这样做的好处，使得原来的“硬件-->操作系统-->虚拟化软件-->虚拟机”这种结构，变成了“硬件-->ESXi5.5系统-->虚拟机”，ESXi5.5系统直接分配硬件资源给虚拟机。或许将ESXi5.5理解成“直接安装在裸机上的虚拟化软件”更合适，这样就可以轻易的理解“ESXi5.5省去了原来操作系统层的占用”这一概念。

3，拓扑图里的软件都有什么作用呢？

- `VMware workstation`：部署虚拟机用的。为了节省资源，3台管理服务器和一台模板服务器都在一台主机的虚拟机上安装。值得注意的是，部署这套环境，最少需要三台管理服务器。一台DC，一台vCenter，一台Connection Server。如果想把他们任何两个装在一起，VMware都会提示“不可以安装在同一台服务器上”。
- `vSphere Client`：VMware公司的软件，安装在windows操作系统上的一个小软件，主要的作用是用来连接ESXi服务器，并管理其中的虚拟机。但一个vSphere Client同一时间只能连接一台ESXi主机，如果想实现批量管理，就需要搭建一台vCenter服务器，由vSphere Client连接到vCenter服务器上后，同时管理多台ESXi主机。
- `vComposer`：VMware公司的软件，即View Composer，和vCenter可以安装在同一台服务器上，用来管理虚拟镜像，节约磁盘资源。
- `View Agent`：安装在虚拟机上（Linux或者Windows）的小软件，作用不用多说也都懂。
- `View Client`：用于连接虚拟桌面的软件，可以安装在Linux、Windows、Android、IOS等操作系统上。和VNC Viewer类似，就是连接到一台装了`View Agent`的虚拟机上并展示图形化界面，但图形效果要比VNC Viewer好很多。

### 云终端选购

云终端的叫法不一，有零终端、云终端、瘦终端、瘦客户机等等。其实就是用于连接虚拟桌面的小设备，一般在上面装个操作系统，然后装个View Client，就能像平常电脑一样连接虚拟机了。市面上的云终端，细细分来，大约有三种。
 
1，**ARM架构云终端**：有的厂商又叫其零终端。这种云终端使用ARM架构，由于是精简指令集，所以功耗小，硬件也比较小巧，且价格较低。使用也是View Client For ARM的软件，当然一般厂商会同时安装主流四大平台的软件。

优点：机箱小（长宽均在15cm左右），便携（可以挂载屏幕后面），功耗小，价格低（400~800）左右，可以连接多种平台的桌面，概念篇中提到的主流四种桌面虚拟化解决方案，基本上都可以支持。

缺点：低功耗带来的较低的显示性能，并且由于是ARM系统，除了用来连接虚拟桌面，也没有办法干别的事情。另外虽然能支持多种平台，但Client的版本更新一般较慢。例如本教程中，由于支持Linux虚拟桌面的Horizon View是最新的6.1.1版本，对应的Client版本为3.4.0，而几家厂商ARM架构的云终端最高只到3.2.0。
 
2，**x86架构云终端**：这种云终端，基本上可以称为瘦客户机了，只不过大家都随便叫罢了。除了机箱小、配置低，和普通PC机比起来也没啥区别。虽然CPU、内存、硬盘的配置都要差很多，且一般都是32位的，但依然可以完整的撑起一个操作系统来。一般在上面装Linux或者Windows，至于能连什么虚拟桌面……操作系统能装什么就能连什么，。当然如果用View Client，一般还是推荐Windows，要比Linux上稳定一些。

优点：机箱小（长宽均在在20cm左右），便携（可以挂载屏幕后面），功耗小（25W左右），价格居中（800~1500），除了可以任意连接任何平台的桌面，不用时还可以干些其他的事情，比如下载东西啊、挂QQ啊之类的，反正就一个低配的操作系统，随你怎么玩咯。

缺点：嗯……还真没怎么有，一般企业也都是用这种的。

3，**芯片云终端**：真正的零终端。这种云终端是专门用来连接Horizon View虚拟桌面的，因为它不像上面的靠软件连接，而是靠VMware和Teradici公司合作生产的硬件连接。这种终端在视频处理性能上是前两种无法比的，一般对显示性能有要求的（如多媒体处理，就是视频处理、3维建模等）公司才会考虑。

优点：机箱小，便携，功耗小，显示性能较高

缺点：贵（2000+了都，因为需从国外进口芯片，且只有那一家公司生产），只支持Horizon View的PCoIP协议，且不方便升级。

>名词解释就到这里啦，如果还有什么不理解的疑问或者建议，请在文章最后左下角点击`展开评论`留言，我会努力解答并修改文章内容哒。

### 软件下载

所有用到的软件，笔者已整理完毕，并在文件上做了详细的标注，链接在此（备注）。最后的“自定义ESXi5.5镜像”文件夹，适合那些想尝试自己注入驱动的人，里面有详细的步骤说明。至于云终端厂家，是当时自己为采购设备搜集的资料，为避免广告之嫌，还是不上传了。

**注意**：上面提到的ESXi5.5系统，格式为iso文件，大小仅330M，利用老毛桃、U大师等软件，将本镜像拷贝到U盘里并制作成启动盘，就可以此操作系统安装在服务器上。但是官方发布的安装包只支持服务器，如果要安装在PC机上面则会出现驱动不全的问题，需要自己手工注入对应的vib格式的驱动包。我已制作了包含全驱动包（25个vib文件）的整合版镜像放到了链接中，大家可直接下载使用。

































